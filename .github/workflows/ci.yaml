name: MLflow CI-CD (LFS & Docker)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      # Langkah "Set up Python 3.10" (sebelumnya langkah 2) telah dihapus
      # karena redundan dengan lingkungan Conda.

      - name: 2. Set up Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          # Baris 'python-version: 3.10' dihapus untuk menghindari konflik.
          # Versi Python sekarang akan dikelola HANYA oleh file conda.yaml.
          auto-activate-base: false
          activate-environment: lung-cancer-env
          environment-file: MLProject/conda.yaml
          
      - name: 3. Install MLflow
        run: pip install "mlflow<3"
        shell: bash -el {0} # Ditambahkan agar berjalan di dalam env conda

      - name: 4. Run MLflow Project (Training)
        run: |
          # Menjalankan MLProject. Ini akan otomatis membuat folder 'mlruns'
          mlflow run MLProject/
        shell: bash -el {0} 

      - name: 5. Get latest MLflow run_id
        id: get_run
        run: |
          RUN_ID=$(mlflow runs list --experiment-id 0 | awk 'FNR == 2 {print $1}')
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
        shell: bash -el {0}

      - name: 6. Upload Model Artifact to GitHub LFS
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add mlruns/
          git commit -m "CI: Add trained model artifact from run ${{ env.RUN_ID }}" || echo "No changes to commit"
          git push
          
      - name: 7. Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 8. Build Docker Model Image
        run: |
          echo "Building Docker image for run_id: ${{ env.RUN_ID }}"
          mlflow models build-docker -m "runs:/${{ env.RUN_ID }}/model" -n "muhamadhamzah/workflow-ci" --enable-mlserver
        shell: bash -el {0}
          
      - name: 9. Push Docker Image to Docker Hub
        run: |
          docker push "muhamadhamzah/workflow-ci:latest"
