name: MLflow CI-CD (LFS & Docker)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: 2. Set up Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: false
          activate-environment: lung-cancer-env
          environment-file: MLProject/conda.yaml
          
      - name: 3. Install MLflow
        run: pip install "mlflow<3"
        shell: bash -el {0} 

      - name: 4. Run MLflow Project (Training)
        run: |
          mlflow run MLProject/
        shell: bash -el {0} 

      - name: 5. Get latest MLflow run_id
        run: |
          # Perintah ini mencari file meta.yaml yang paling baru diubah
          # dan mengambil nama direktorinya (yaitu run_id)
          RUN_ID=$(find mlruns/0 -name "meta.yaml" -printf "%T@ %p\n" | sort -n | tail -1 | cut -d' ' -f2 | xargs dirname | xargs basename)
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Latest run_id: $RUN_ID"
        shell: bash -el {0}

      - name: 6. Upload Model Artifact to GitHub LFS
        # Ini adalah langkah untuk LFS yang Anda maksud
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add mlruns/
          git commit -m "CI: Add trained model artifact from run ${{ env.RUN_ID }}" || echo "No changes to commit"
          git push
          
      - name: 7. Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          # TYPO DIPERBAIKI: DOKCERHUB -> DOCKERHUB
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 8. Build Docker Model Image
        run: |
          echo "Building Docker image for run_id: ${{ env.RUN_ID }}"
          mlflow models build-docker -m "runs:/${{ env.RUN_ID }}/model" -n "muhamadhamzah/workflow-ci"
        shell: bash -el {0}
        
          
      - name: 9. Push Docker Image to Docker Hub
        run: |
          docker push "muhamadhamzah/workflow-ci:latest"
